# 存储和文件结构
## 物理存储介质概述
- 大多数计算机系统中存在多种数据存储类型。可以根据访问数据的速度、成本、可靠性分类。
    - 高速缓冲存储器(cache)。（一般指cpu的缓存）
        - 高速缓冲存储器是最快最昂贵的存储介质，一般很小，由计算机系统硬件来管理。
    - 主存储器(main memory)。(一般指内存)
        - 主存储器是用于存放可处理的数据的存储介质。
    - 快闪存储器(flash memory)。
        - 快闪存储器不同于主存储器的地方是电源关闭时数据可保存下来。目前有两种类型的快闪存储器，称作NAND和NOR快闪。
    - 磁盘存储器(magnetic-disk memory)。
        - 用于长期联机数据存储的主要介质是磁盘。

- 根据不同存储介质的速度和成本，可以把他们按层次结构组织起来。层次越高，成本越高，速度越快。
    1. cache
    2. main memory
    3. flash memory
    4. magnetic-disk memory
- 最快的存储介质(如1和2)称为基本存储(primary storage)。
- 基本存储的下一层(磁盘)称为辅助存储(secondary storage)或联机存储(online storage)。
- 最低的层次称为三级存储(tertiary storage)或脱机存储(offline storage)。
- 不同存储系统除了速度和成本不一样，还存在一个存储易失性的问题。`易失性存储`(volatile storage)在设备断电后会丢失所有内容。
    - 基本存储是 易失性存储
    - 其他为 非易失性存储(nonvolatile storage)
- 为了保护数据，必须把数据写到 非易失性存储 中。

## 磁盘和快闪存储器
### 磁盘的物理特性
- 磁盘的物理结构：
    - 盘片(platter)
        - 磁盘有多个盘片，盘片是扁平的圆盘，他的两面都覆盖着磁性物质，信息就记录在上面。每条磁盘有1-5个盘片。
    - 读写头(read-write head)
        - 通过反转磁性物质磁化的方向，读写头将信息磁化存储到扇区中。
        - 磁盘的每个盘片的每一面都有一个读写头，读写头通过在盘片上移动来访问磁道。
    - 磁道(track)
        - 盘片的表面从逻辑上划分为磁道。每个盘片约有5,000~100,000条磁道。内侧的磁道（离转轴近的地方）长度较短，外侧磁道比内侧磁道有更多的山区。内侧磁道大约包含500~1000扇区，外侧1000~2000.
    - 扇区(sector)
        - 磁道又划分为扇区。是磁盘读出写入的最小单位。大小一般为512字节。
    - 簇
    - 柱面
    - 磁盘臂(disk arm)
        - 所有磁道的读写头安装在一个称为磁盘臂的单独装置上，并且一起移动。
        - 因为一起移动，当某一个盘片的读写头在第i条磁道上时，所有其他盘片的读写头也都在对应的i磁道上。
        - 因此，所有盘片的第i条磁道合在一起称为第i个柱面(cylinder).
- 当磁盘被使用时，会以恒定的高速旋转(7200 5400转就是指这个速度)。有一个读写头恰好位于盘片表面的上方。

- 磁盘控制器(disk controller)
    - 作为计算机系统和实际的磁盘驱动器硬件之间的接口。在磁盘驱动单元内部实现。
    - 接收高层次的读写扇区命令，移动磁盘臂和读写数据。
    - 他所写的每个扇区附加校验和(checksum)，校验和从写的数据计算得到的。
    - 每次读扇区数据会重新计算校验和比较，如果数据被破坏，校验和不一致的可能性就很高。
    - 如果校验和不一致，重读几次依旧不一致，发出读失败的信号。
    - 另一个任务是 `坏扇区的重映射`(remapping of bad sector)。如果检测到坏扇区，会把它的逻辑映射到另一个物理位置。（磁盘中有为此而设的额外扇区）。
- 磁盘接口有几个
    - SATA
    - SCSI
    - SAS

### 磁盘性能的度量
- 主要度量指标有 `容量` `访问时间` `数据传输率` `可靠性`。

1. 访问时间(access time)是从发出读写请求道数据开始传输之间的时间。
    - 为了访问扇区，磁盘臂首先移动定位到正确的磁道，然后等待磁盘旋转，直到指定的扇区出现在他的下方。磁盘臂重定位的时间称为 `寻道时间`(seek time)。它随磁盘臂移动距离增大而增大。
    - `平均寻道时间`(average seek time)是寻道时间的平均值，平均寻道时间大约是最长寻道时间的1/2.现在平均寻道时间约在4~10 ms之间。
    - 一旦读写头到达了所需的磁道，等待访问的扇区出现在读写头下所花费的时间称为`旋转等待时间`(rotational latency time)。
    - 一般磁盘的转速在每分钟5400转到15000，或说4~11ms每转。磁盘的`平均旋转等待时间`为磁盘旋转一周时间的1/2。
    - 访问时间是 `平均寻道时间` + `平均旋转等待时间`。范围在8~20ms之间。一旦带访问数据的第一个扇区来到读写头下，数据传输就开始了。

2. 数据传输率(data-transfer rate)是从磁盘获得数据或者向磁盘存储数据的速率。
    - 目前 最大传输率约为25~100MB/S,内侧磁道传输率明显低于最大传输率。如max 为 100MB的，内侧磁道传输率约为30MB.

3. 平均故障时间(Mean Time To Failure, MTTF),磁盘可靠性的度量标准。
    - 给定1000张磁盘，如果MTTF是1 200 000小时，则平均来说在1200小时内(1 200 000/1000)会有一张故障。

### 磁盘块访问的优化
- 磁盘I/O请求由文件系统和虚拟内存管理器产生的。每个请求制定了要访问的磁盘地址，这个地址是以 `块号` 的形式提供的。
    - 一个块(block)是一个逻辑单元，它包含固定数目的连续扇区。
    - 块大小在512字节到几KB.数据在磁盘和主存储器之间以块为单位传输。术语页(page)常指块。
- 来自磁盘的连续请求可以归类为 `顺序访问模式` 或 `随机访问模式`。
    - 在一个 `顺序访问`(sequential access)模式中，连续的请求会请求处于相同的磁道或是相邻的磁道上连续的块。访问第一块需要寻道时间，但是相继的请求不需要寻道。(也就是测速时的顺序存储速度)
    - `随机访问`(random access)，相继的请求会请求随机的块，每一个请求都需要寻道，一张磁盘一秒能满足的随机块访问数量取决于寻道时间，通常是每秒100~200。(测速时的随机速度)
- 为了提高访问块的速度，产生了许多技术。

